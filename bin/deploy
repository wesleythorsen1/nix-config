#!/usr/bin/env bash

set -euo pipefail

NIX_SSHOPTS="-o BatchMode=yes" nixos-rebuild build \
  --flake .#thinkpad \
  --build-host wes@thinkpad \
  --target-host wes@thinkpad \
  --use-substitutes \
  --sudo \
  --verbose

# export NIX_SSHOPTS="-tt"

# # Build wrapper locally
# env NIX_BUILDERS= \
#   nix build .#nixosConfigurations.thinkpad.config.system.build.nixos-rebuild \
#   -L -o /tmp/nr

# # Use it to build/switch ThinkPad via the linux-builder VM
# exec /tmp/nr/bin/nixos-rebuild switch \
#   --flake .#thinkpad \
#   --build-host builder@linux-builder \
#   --target-host wes@thinkpad \
#   --use-remote-sudo \
#   --verbose

# nixos-rebuild switch \
#   --flake .#thinkpad \
#   --build-host builder@linux-builder \
#   --target-host wes@thinkpad \
#   --option builders '' \
#   --use-remote-sudo \
#   --verbose

# env NIX_BUILDERS= \
#   nix run nixpkgs#nixos-rebuild -- \
#     switch \
#     --flake .#thinkpad \
#     --build-host builder@linux-builder \
#     --target-host wes@thinkpad \
#     --use-remote-sudo \
#     --verbose

# nix run nixpkgs#nixos-rebuild -- \
#   switch \
#   --flake .#thinkpad \
#   --build-host builder@linux-builder \
#   --target-host wes@thinkpad \
#   --option builders '' \
#   --use-remote-sudo \
#   --verbose
#   # --fast \

